# Database Migration Guide

## Overview

This project uses Alembic for database migrations. Migrations allow you to version control your database schema and apply changes consistently across environments.

## Initial Setup

1. **Install dependencies** (already done if you've run `uv sync`):
   ```bash
   uv sync
   ```

2. **Create initial migration**:
   ```bash
   cd backend
   alembic revision --autogenerate -m "Initial migration"
   ```

3. **Review the migration file** in `alembic/versions/` to ensure it's correct.

4. **Apply migrations**:
   ```bash
   alembic upgrade head
   ```

## Common Commands

### Create a new migration
```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply migrations
```bash
# Apply all pending migrations
alembic upgrade head

# Apply migrations up to a specific revision
alembic upgrade <revision>
```

### Rollback migrations
```bash
# Rollback one migration
alembic downgrade -1

# Rollback to a specific revision
alembic downgrade <revision>

# Rollback all migrations
alembic downgrade base
```

### View migration history
```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

## Migration Workflow

### Development
1. Make changes to models in `app/models_db.py`
2. Create migration: `alembic revision --autogenerate -m "Description"`
3. Review the generated migration file
4. Apply migration: `alembic upgrade head`
5. Test your changes

### Staging/Production
1. Pull latest code
2. Apply migrations: `alembic upgrade head`
3. Verify database schema

## Important Notes

- **Always review autogenerated migrations** before applying them
- **Test migrations on a copy of production data** before applying to production
- **Never edit existing migration files** that have been applied to production
- **Create a new migration** if you need to change an existing one
- **Backup your database** before running migrations in production

## Troubleshooting

### Migration conflicts
If you have conflicts between branches:
1. Identify the conflicting migrations
2. Create a merge migration: `alembic merge -m "Merge migrations" <rev1> <rev2>`
3. Resolve conflicts in the merge migration file

### Failed migration
If a migration fails:
1. Check the error message
2. Fix the issue in the migration file (if not yet applied)
3. Or create a new migration to fix the issue
4. Rollback if needed: `alembic downgrade -1`

### Database out of sync
If your database is out of sync:
1. Check current revision: `alembic current`
2. Check expected revision: `alembic heads`
3. Apply pending migrations: `alembic upgrade head`

## Seed Data

To seed the database with initial test data:
```bash
python -m scripts.seed_db
```

Note: This script will create test users and scores. It's safe to run multiple times (it checks for existing data).

